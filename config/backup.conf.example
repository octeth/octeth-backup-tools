# ============================================
# Octeth Backup Tool - Main Configuration
# ============================================
# This file is sourced by backup scripts
# Copy to backup.conf and customize as needed

# Load environment variables from .env file
# Determine the directory where this config file is located
# Use BASH_SOURCE for sourced files, fall back to $0 for direct execution
_BACKUP_CONF_DIR="$(cd "$(dirname "${BASH_SOURCE[0]:-$0}")" && pwd)"

# Try multiple locations for .env file
_ENV_FILE=""
if [ -f "${_BACKUP_CONF_DIR}/.env" ]; then
    _ENV_FILE="${_BACKUP_CONF_DIR}/.env"
elif [ -f "${_BACKUP_CONF_DIR}/../config/.env" ]; then
    _ENV_FILE="${_BACKUP_CONF_DIR}/../config/.env"
elif [ -f "/opt/octeth-backup-tools/config/.env" ]; then
    _ENV_FILE="/opt/octeth-backup-tools/config/.env"
elif [ -f "/etc/octeth-backup/.env" ]; then
    _ENV_FILE="/etc/octeth-backup/.env"
fi

if [ -n "${_ENV_FILE}" ] && [ -f "${_ENV_FILE}" ]; then
    set -a
    source "${_ENV_FILE}"
    set +a
else
    echo "Error: Configuration file (.env) not found"
    echo "Searched locations:"
    echo "  - ${_BACKUP_CONF_DIR}/.env"
    echo "  - ${_BACKUP_CONF_DIR}/../config/.env"
    echo "  - /opt/octeth-backup-tools/config/.env"
    echo "  - /etc/octeth-backup/.env"
    # Use return if sourced, exit if executed directly
    return 1 2>/dev/null || exit 1
fi

# Clean up temporary variables
unset _BACKUP_CONF_DIR _ENV_FILE

# ============================================
# Backward Compatibility
# ============================================
# Handle old S3_UPLOAD_ENABLED variable
if [ -n "${S3_UPLOAD_ENABLED:-}" ]; then
    if [ "${S3_UPLOAD_ENABLED}" = "true" ]; then
        CLOUD_STORAGE_PROVIDER="${CLOUD_STORAGE_PROVIDER:-s3}"
    else
        CLOUD_STORAGE_PROVIDER="${CLOUD_STORAGE_PROVIDER:-none}"
    fi
fi

# Set default if not specified
CLOUD_STORAGE_PROVIDER="${CLOUD_STORAGE_PROVIDER:-none}"

# ============================================
# Backup Naming Convention
# ============================================
# Format: octeth-backup-YYYY-MM-DD_HH-MM-SS
# Example: octeth-backup-2025-01-15_02-00-00

BACKUP_PREFIX="octeth-backup"
DATE_FORMAT="%Y-%m-%d_%H-%M-%S"

# ============================================
# Backup Types and Directories
# ============================================

BACKUP_TYPE_DAILY="daily"
BACKUP_TYPE_WEEKLY="weekly"
BACKUP_TYPE_MONTHLY="monthly"

DAILY_DIR="${BACKUP_DIR}/${BACKUP_TYPE_DAILY}"
WEEKLY_DIR="${BACKUP_DIR}/${BACKUP_TYPE_WEEKLY}"
MONTHLY_DIR="${BACKUP_DIR}/${BACKUP_TYPE_MONTHLY}"

# ============================================
# MySQL Container Access
# ============================================

# Docker exec command template
DOCKER_EXEC="${DOCKER_CMD} exec ${MYSQL_HOST}"

# MySQL client command inside container
MYSQL_CMD="mysql -u${MYSQL_USERNAME} -p${MYSQL_PASSWORD} -h${MYSQL_HOST}"

# XtraBackup command template
XTRABACKUP_CMD="${XTRABACKUP_BIN} --backup --target-dir=%TARGET_DIR%"

# ============================================
# Health Check Settings
# ============================================

# Minimum free space required (in GB)
MIN_FREE_SPACE_GB=10

# MySQL connection timeout (seconds)
MYSQL_CONNECT_TIMEOUT=10

# ============================================
# S3 Upload Settings
# ============================================

# AWS CLI command template
AWS_CMD="aws s3 cp %SOURCE% s3://${S3_BUCKET}/${S3_PREFIX}/%DEST% --region ${S3_REGION} --storage-class ${S3_STORAGE_CLASS}"

# rclone command template
RCLONE_CMD="rclone copy %SOURCE% ${RCLONE_REMOTE}:${S3_BUCKET}/${S3_PREFIX}/%DEST%"

# ============================================
# Retention Policy Details
# ============================================

# Day of week for weekly backups (0=Sunday, 1=Monday, etc.)
WEEKLY_DAY=0

# Day of month for monthly backups (1-31)
MONTHLY_DAY=1

# ============================================
# Notification Templates
# ============================================

EMAIL_SUBJECT_SUCCESS="[SUCCESS] Octeth Backup Completed"
EMAIL_SUBJECT_FAILURE="[FAILURE] Octeth Backup Failed"

WEBHOOK_PAYLOAD_SUCCESS='{"status":"success","message":"Octeth backup completed","timestamp":"%TIMESTAMP%","backup_size":"%SIZE%"}'
WEBHOOK_PAYLOAD_FAILURE='{"status":"failure","message":"Octeth backup failed","timestamp":"%TIMESTAMP%","error":"%ERROR%"}'
